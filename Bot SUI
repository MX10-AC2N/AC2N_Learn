import os
import asyncio
from datetime import datetime
from sui import SuiClient  # SDK Sui (à installer)
from telegram import Bot
from telegram.ext import ApplicationBuilder, CommandHandler

# Configuration
SUI_NODE_URL = os.getenv("SUI_NODE_URL", "https://fullnode.devnet.sui.io:443")
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

# Initialisation
sui_client = SuiClient(SUI_NODE_URL)
telegram_bot = Bot(token=TELEGRAM_TOKEN)

async def fetch_new_tokens():
    """Récupère les nouveaux tokens déployés sur Sui."""
    try:
        # Exemple : récupérer les derniers événements de déploiement de tokens
        events = sui_client.get_events("TokenDeployed")
        for event in events:
            token_address = event["token_address"]
            creator = event["creator"]
            print(f"Nouveau token détecté : {token_address} par {creator}")
            await analyze_token(token_address, creator)
    except Exception as e:
        print(f"Erreur lors de la récupération des tokens : {e}")

async def analyze_token(token_address: str, creator: str):
    """Analyse un token pour détecter des risques."""
    # Vérification de la concentration des tokens
    holders = sui_client.get_token_holders(token_address)
    if len(holders) == 1 and holders[0]["address"] == creator:
        await send_alert(f"⚠️ Token suspect : {token_address} (100% détenu par le créateur)")

    # Vérification des métadonnées
    metadata = sui_client.get_token_metadata(token_address)
    if not metadata.get("name") or not metadata.get("symbol"):
        await send_alert(f"⚠️ Token incomplet : {token_address} (métadonnées manquantes)")

async def send_alert(message: str):
    """Envoie une alerte sur Telegram."""
    await telegram_bot.send_message(chat_id=TELEGRAM_CHAT_ID, text=message)

async def monitor_tokens():
    """Boucle principale pour surveiller les nouveaux tokens."""
    while True:
        await fetch_new_tokens()
        await asyncio.sleep(60)  # Vérifie toutes les 60 secondes

# Commandes Telegram
async def start(update, context):
    await update.message.reply_text("Bienvenue sur Sui Bot! Surveillance des nouveaux tokens en cours...")

# Lancement du bot
if __name__ == "__main__":
    application = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    
    loop = asyncio.get_event_loop()
    loop.create_task(monitor_tokens())
    loop.create_task(application.run_polling())
    loop.run_forever()